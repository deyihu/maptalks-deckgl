/*!
 * maptalks-deckgllayer v0.0.1
 * LICENSE : MIT
 * (c) 2016-2019 maptalks.org
 */
/*!
 * requires maptalks@^0.25.1 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("deck.gl")):"function"==typeof define&&define.amd?define(["exports","maptalks","deck.gl"],e):e(t.maptalks=t.maptalks||{},t.maptalks,t.deck)}(this,function(t,e,n){"use strict";function r(t,e){for(var n=Object.getOwnPropertyNames(e),r=0;r<n.length;r++){var i=n[r],o=Object.getOwnPropertyDescriptor(e,i);o&&o.configurable&&void 0===t[i]&&Object.defineProperty(t,i,o)}return t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function s(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):r(t,e))}function a(t){return 19-Math.log(t/l)/Math.LN2}var p={container:"front",renderer:"dom",zoomOffset:0},c=function(t){function r(){return i(this,r),o(this,t.apply(this,arguments))}return s(r,t),r.prototype.setProps=function(t){var n=this._getRenderer();this.props=e.Util.extend({},t);var r=this._initDeckOption(t);return n&&n.deckgl.setProps(r),this},r.prototype.onRemove=function(){this.syncAnimation&&cancelAnimationFrame(this.syncAnimation);var e=this._getRenderer();e&&e.deckgl.finalize(),t.prototype.onRemove.call(this)},r.prototype.setOpacity=function(t){var e=this._getRenderer();if(e){e._container.style.opacity=t}return this},r.prototype.getOpacity=function(){var t=this._getRenderer();if(t){var e=t._container;return Math.min(1,parseFloat(e.style.opacity))}return 0},r.prototype.setZIndex=function(t){var e=this._getRenderer();if(e){e._container.style.zIndex=t}return this},r.prototype.getZIndex=function(){var t=this._getRenderer();if(t){var e=t._container;if(e)return e.style.zIndex}return 0},r.prototype.show=function(){var t=this._getRenderer();return t&&t.show(),this},r.prototype.hide=function(){var t=this._getRenderer();return t&&t.hide(),this},r.prototype._initDeckOption=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.layers||[],r=[];return n.forEach(function(e){r.push(t._getDeckLayer(e))}),e.layers=r,e},r.prototype._getDeckLayer=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.layerType,i=e.Util.extend({},t);return new n[r](i)},r}(e.Layer);c.mergeOptions(p);var h=function(){function t(e){i(this,t),this.layer=e}return t.prototype.render=function(){this._container||this._createLayerContainer(),this.sync(),this.layer.fire("layerload")},t.prototype.drawOnInteracting=function(){this.sync()},t.prototype.sync=function(){var t=this.getView();this.deckgl&&this.deckgl.setProps&&this.deckgl.setProps({viewState:e.Util.extend({},t)})},t.prototype.needToRedraw=function(){var t=this.getMap(),e=t._getRenderer();return t.isInteracting()||e&&(e.isStateChanged&&e.isStateChanged()||e.isViewChanged&&e.isViewChanged())},t.prototype.getMap=function(){return this.layer.getMap()},t.prototype._isVisible=function(){return this._container&&""===this._container.style.display},t.prototype.show=function(){this._container&&(this._container.style.display="")},t.prototype.hide=function(){this._container&&(this._container.style.display="none")},t.prototype.setZIndex=function(t){this._zIndex=t,this._container&&(this._container.style.zIndex=t)},t.prototype.getZIndex=function(){return this._zIndex||0},t.prototype.remove=function(){this._removeLayerContainer()},t.prototype.isCanvasRender=function(){return!1},t.prototype.initDeckGL=function(){var t={canvas:this._container.firstChild},r=e.Util.extend({},t,{viewState:this.getView()});this.deckgl=new n.Deck(r);var i=this.layer;i&&i.props&&i.setProps(i.props)},t.prototype._createLayerContainer=function(){var t=this._container=e.DomUtil.createEl("div"),n=document.createElement("canvas");n.getContext("webgl2",{preserveDrawingBuffer:!0}),t.appendChild(n),t.style.cssText="position:absolute;left:0px;top:0px;opacity:1;",this._zIndex&&(t.style.zIndex=this._zIndex),this._resetContainer(),("front"===this.layer.options.container?this.getMap()._panels.frontStatic:this.getMap()._panels.backStatic).appendChild(t),this.deckgl||this.initDeckGL()},t.prototype._removeLayerContainer=function(){this._container&&e.DomUtil.removeDomNode(this._container),delete this._levelContainers},t.prototype._resetContainer=function(){var t=this.getMap().getSize();this._container.style.width=t.width+"px",this._container.style.height=t.height+"px";var e=this._container.firstChild;e.width="100%",e.height="100%",this.sync()},t.prototype.getEvents=function(){return{_resize:this._resetContainer}},t.prototype.getView=function(){var t=this.getMap(),e=this.layer.options.zoomOffset,n=t.getCenter(),r=(t.getZoom(),t.getBearing()),i=t.getPitch(),o=t.getMaxZoom();return{longitude:n.x,latitude:n.y,zoom:a(t.getResolution())-e,maxZoom:o-1,pitch:i,bearing:r,width:"100%",height:"100%"}},t}(),l=12756274*Math.PI/(256*Math.pow(2,20));c.registerRenderer("dom",h),t.DeckGLLayer=c,t.DeckGLRenderer=h,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks-deckgllayer v0.0.1, requires maptalks@^0.25.1.")});